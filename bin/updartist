#!/bin/bash

MNT_PT="/mnt/transcend/Pictures"
ART_DIR="${MNT_PT}/MagicMirror/Artists"
RMLIST="/usr/local/MirrorCommandLine/etc/rmlist.txt"

# Use an associative array to map artist names across sites
declare -A artist_sites

[ -d ${ART_DIR} ] || {
  MNT_PT="/u/pictures"
  ART_DIR="${MNT_PT}/MagicMirror/Artists"
  [ -d ${ART_DIR} ] || {
    echo "$ART_DIR does not exist or is not a directory. Exiting."
    exit 1
  }
}
cd ${ART_DIR}
TOP="${MNT_PT}/Wallhaven"
MOD="${TOP}/Models"
ART="${TOP}/Artists"
JAV="${TOP}/JAV_Idol"
PHO="${TOP}/Photographers"
PLA="${MOD}/Playboy"
PEN="${MOD}/Penthouse"
DRO="${MOD}/Photodromm"
KIND="${MNT_PT}/KindGirls"
ELITE="${MNT_PT}/Elite_Babes"

isportrait() {
    port=0
    #GEO=`identify "$1" | awk ' { print $(NF-6) } '`
    GEO=`identify "$1" | awk ' { print $3 } '`
    W=`echo $GEO | awk -F "x" ' { print $1 } '`
    # Check if width not greater than 600
    [ "$W" ] && [ $W -gt 600 ] || {
        port=1
        return $port
    }
    H=`echo $GEO | awk -F "x" ' { print $2 } '`
    # Check if height not greater than 800
    [ "$H" ] && [ $H -gt 800 ] || {
        port=1
        return $port
    }
    # Check if width less than height
    [ "$W" ] && [ "$H" ] && [ $W -lt $H ] || {
        port=1
        return $port
    }
    return $port
}

portrait=1
[ "$1" == "-l" ] && {
    portrait=
    shift
}

[ "$1" ] || {
    echo "Use 'mmupdall' to update all folders."
    echo "This script requires a folder or folders as arguments."
    echo "Exiting."
    exit 1
}

for folder in $*
do
    [ "$folder" == "*" ] && continue
    [ "$folder" == "Unused" ] && continue
    [ -d $folder ] || continue
    cd $folder
    for img in *
    do
        [ "$img" == "*" ] && continue
        if [ -d "$img" ]
        then
            for subimg in $img/*
            do
                [ "$subimg" == "$img/*" ] && continue
                [ -L $subimg ] && rm -f $subimg
                grep $subimg $RMLIST > /dev/null && {
                    rm -f $subimg
                    continue
                }
                for ADIR in $MOD $ART $JAV $PHO $KIND $PLA $PEN $DRO $TOP $ELITE
                do
                    [ -f $ADIR/$folder/$subimg ] && {
                        rm -f $subimg
                        cp $ADIR/$folder/$subimg $subimg
                        break
                    }
                done
              done
        else
            [ -L $img ] && rm -f $img
            grep $img $RMLIST > /dev/null && {
                rm -f $img
                continue
            }
            for ADIR in $MOD $ART $JAV $PHO $KIND $PLA $PEN $DRO $TOP $ELITE
            do
                [ -f $ADIR/$folder/$img ] && {
                    rm -f $img
                    cp $ADIR/$folder/$img .
                    break
                }
            done
        fi
    done
    cd ${ART_DIR}
done

# Identify any newly added files and copy them
for folder in $*
do
    [ "$folder" == "*" ] && continue
    [ "$folder" == "Unused" ] && continue
    [ -d $folder ] || continue
    # In case we need this in the future, follow the example of model sites
    case $folder in
        Jenya)
            artist_sites[$ELITE]="Eugenia_Diordiychuk"
            ;;
        Natalia_Andreeva)
            artist_sites[$ELITE]="Delilah_G"
            artist_sites[$KIND]="Natalia_A"
            ;;
        Niemira)
            artist_sites[$ELITE]="Niemira_A"
            ;;
        Priscilla_Huggins)
            artist_sites[$ELITE]="Priscilla_Huggins_Ortiz"
            ;;
        *)
            ;;
    esac
    for ADIR in $MOD $ART $JAV $PHO $KIND $PLA $PEN $DRO $TOP $ELITE
    do
      chkfolder=$folder
      [ "${artist_sites[$ADIR]}" ] && {
              chkfolder="${artist_sites[$ADIR]}"
      }
      [ -d $ADIR/$chkfolder ] && {
        echo "Checking $ADIR/$chkfolder for newly added files"
        cd $ADIR/$chkfolder
        for img in *
        do
            [ "$img" == "*" ] && continue
            [ "$img" == "downloaded.txt" ] && continue
            [ "$img" == "SUMS.txt" ] && continue
            [ "$img" == "Description.txt" ] && continue
            if [ -d "$img" ]
            then
                [ -d ${ART_DIR}/$folder/$img ] || mkdir -p ${ART_DIR}/$folder/$img
                for subimg in $img/*
                do
                    [ "$subimg" == "$img/*" ] && continue
                    [ -L ${ART_DIR}/$folder/$subimg ] && {
                        rm -f ${ART_DIR}/$folder/$subimg
                    }
                    grep $subimg $RMLIST > /dev/null && {
                        rm -f $subimg
                        continue
                    }
                    if isportrait $subimg
                    then
                        [ "${portrait}" ] && {
                          cp $ADIR/$chkfolder/$subimg ${ART_DIR}/$folder/$subimg
                        }
                    else
                        [ "${portrait}" ] || {
                          cp $ADIR/$chkfolder/$subimg ${ART_DIR}/$folder/$subimg
                        }
                    fi
                done
            else
                [ -L ${ART_DIR}/$folder/$img ] && rm -f ${ART_DIR}/$folder/$img
                grep $img $RMLIST > /dev/null && {
                    rm -f $img
                    continue
                }
                if isportrait $img
                then
                    [ "${portrait}" ] && {
                      cp $ADIR/$chkfolder/$img ${ART_DIR}/$folder/$img
                    }
                else
                    [ "${portrait}" ] || {
                      cp $ADIR/$chkfolder/$img ${ART_DIR}/$folder/$img
                    }
                fi
            fi
        done
        cd ${ART_DIR}
      }
    done
    cd ${ART_DIR}
done
