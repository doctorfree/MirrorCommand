#!/bin/bash
#
# Usage: ./Install [package names]
#   If no package names are specified then all currently
#   supported packages will be installed
#
# Versions of apt prior to 1.1 do not support install by Debian filename
# You should probably be running a more recent version of apt
# On these early versions, install with the following:
#
# sudo dpkg -i "${DEB}"
# sudo apt-get install -f

SRC_NAME="MirrorCommandLine"
PKG_NAMES="MirrorCommandLine MirrorImagesPortrait ArtistsPortrait \
           ModelsPortrait PhotographersPortrait"
SRC="${HOME}/src"

[ -f "${SRC}/${SRC_NAME}/VERSION" ] || {
  echo "Missing VERSION file: ${SRC}/${SRC_NAME}/VERSION"
  echo "Exiting"
  exit 1
}

. "${SRC}/${SRC_NAME}/VERSION"
PKG_VER=${VERSION}

[ "$1" ] && {
  PKG_NAMES="$*"
  for nam in ${PKG_NAMES}
  do
    echo "${PKG_NAMES}" | grep ${nam} > /dev/null || {
      echo "${nam} is not a valid package name. Skipping installation of ${nam}"
      PKG_NAMES=`echo "${PKG_NAMES}" | sed -e "s/${nam}//"`
    }
  done
  echo "${PKG_NAMES}" | grep MirrorCommandLine > /dev/null && {
    # Make sure MirrorCommandLine is installed first
    pkg_names_tmp=`echo "${PKG_NAMES}" | sed -e "s/MirrorCommandLine//"`
    PKG_NAMES="MirrorCommandLine ${pkg_names_tmp}"
  }
}

[ "${PKG_NAMES}" ] || {
  echo "No valid Package names specified. Exiting."
  exit 1
}

for PKG_NAME in ${PKG_NAMES}
do
  DEB="${SRC}/${SRC_NAME}/releases/${PKG_VER}/${PKG_NAME}_${PKG_VER}.deb"
  [ -f "${DEB}" ] || {
    echo "${PKG_NAME}_${PKG_VER}.deb not found."
    for debs in ${SRC}/${SRC_NAME}/releases/*/${PKG_NAME}_*.deb
    do
      [ "${debs}" == "${SRC}/${SRC_NAME}/releases/*/${PKG_NAME}_*.deb" ] || {
        echo "Found existing packages:"
        echo "${debs}"
      }
    done
    echo ""
    continue
  }

  echo "Installing ${DEB}"
  sudo apt install "${DEB}"
done
