#!/bin/bash
# preinst script for mirrorcommandline
#
# see: dh_installdeb(1)

set -e

case "$1" in
    install|upgrade)
        MMHOME="/home/pi/MagicMirror"
        USER=
        GROUP=
        [ -d ${MMHOME}/config ] || {
            MMHOME=
            for homedir in /usr/local /home/*
            do
                [ "${homedir}" == "/home/*" ] && continue
                [ -d ${homedir}/MagicMirror/config ] && {
                    MMHOME="${homedir}/MagicMirror"
                    break
                }
            done
        }
        [ "${MMHOME}" ] || {
            echo ""
            echo "Unable to locate a MagicMirror installation on this system."
            echo "MagicMirror is required in order to install MirrorCommandLine."
            echo ""
            while true
            do
              read -p "Install MagicMirror ? ('Y'/'N'): " yn
              case $yn in
                  [Yy]*)
                      numusers=0
                      users=
                      for user in /home/*
                      do
                          [ "${user}" == "/home/*" ] && continue
                          [ -d ${user} ] && {
                              USER=`basename ${user}`
                              users="${users} ${USER}"
                              numusers=`expr ${numusers} + 1`
                          }
                      done
                      [ $numusers -gt 1 ] && {
                          echo ""
                          # Create a selection dialog to allow user to select USER
                          PS3="${BOLD}Please enter MagicMirror user (numeric or text): ${NORMAL}"
                          options=(${users})
                          select opt in "${options[@]}"
                          do
                            case "$opt,$REPLY" in
                              *)
                                  [ -d /home/${opt} ] && {
                                      USER="${opt}"
                                      break
                                  }
                                  printf "\nInvalid entry. Please try again"
                                  printf "\nEnter either a number or text of one of the menu entries\n"
                                  ;;
                            esac
                          done
                      }
                      [ "${USER}" ] || {
                          echo "No MagicMirror user found or selected. Using root."
                          USER="root"
                      }
                      [ -d /usr/local ] || mkdir /usr/local
                      cd /usr/local
                      git clone https://github.com/MichMich/MagicMirror > /dev/null
                      GROUP=`id -g -n ${USER}`
                      chown -R ${USER}:${GROUP} MagicMirror
                      cd MagicMirror
                      MMHOME="/usr/local/MagicMirror"
                      echo "Installing MagicMirror in /usr/local/MagicMirror"
                      sudo -u ${USER} npm install > /dev/null 2>&1
                      # sudo -u ${USER} cp config/config.js.sample config/config.js
                      break
                      ;;
                  [Nn]*)
                      exit 1
                      ;;
                  * )
                      echo "Please answer yes or no."
                      ;;
              esac
            done
        }
        MSO="${MMHOME}/.mirrorscreen"
        [ -f ${MSO} ] && mv ${MSO} ${MSO}.bak$$
        echo "# MirrorCommandLine Display Configuration" > ${MSO}
        echo "# The SCREEN_# associative arrays contain the mode and device" >> ${MSO}
        echo "# for each screen. A 'mode' value of '1' indicates Portrait mode" >> ${MSO}
        echo "# while an empty 'mode' value indicates Landscape mode" >> ${MSO}
        echo "# To get a list of your active display screens, execute the command:" >> ${MSO}
        echo "#    xrandr --listactivemonitors" >> ${MSO}
        echo "" >> ${MSO}
        echo "# MM_SCREEN is the screen number on which MagicMirror will display" >> ${MSO}
        echo "MM_SCREEN=0" >> ${MSO}
        echo ""
        echo "Portrait mode display screens are taller than wide."
        echo "Landscape mode display screens are wider than tall."
        echo ""
        numscreens=`xrandr --listactivemonitors | grep Monitors: | awk ' { print $2 } '`
        screens=0
        while [ ${screens} -lt ${numscreens} ]
        do
          HDMI=`xrandr --listactivemonitors | grep ${screens}: | awk ' { print $4 } '`
          # Create a selection dialog to allow user to select screen orientation
          if [ ${numscreens} -gt 1 ]
          then
            if [ ${screens} -eq 0 ]
            then
              PS3="${BOLD}Please enter your primary display screen's orientation (numeric or text): ${NORMAL}"
            else
              PS3="${BOLD}Please enter your secondary display screen's orientation (numeric or text): ${NORMAL}"
            fi
          else
            PS3="${BOLD}Please enter your display screen's orientation (numeric or text): ${NORMAL}"
          fi
          options=(Portrait Landscape Unknown)
          select opt in "${options[@]}"
          do
            case "$opt,$REPLY" in
              "Portrait",*|*,"Portrait"|"portrait",*|*,"portrait")
                echo "Using portrait display mode"
                echo "" >> ${MSO}
                echo "# SCREEN_${screens} stores the mode and device for screen ${screens}" >> ${MSO}
                echo "declare -A SCREEN_${screens}" >> ${MSO}
                echo "SCREEN_${screens}[mode]=1" >> ${MSO}
                echo "SCREEN_${screens}[hdmi]=${HDMI}" >> ${MSO}
                break
                ;;
              "Landscape",*|*,"Landscape"|"landscape",*|*,"landscape")
                echo "Using landscape display mode"
                echo "" >> ${MSO}
                echo "# SCREEN_${screens} stores the mode and device for screen ${screens}" >> ${MSO}
                echo "declare -A SCREEN_${screens}" >> ${MSO}
                echo "SCREEN_${screens}[mode]=" >> ${MSO}
                echo "SCREEN_${screens}[hdmi]=${HDMI}" >> ${MSO}
                break
                ;;
              "Unknown",*|*,"Unknown"|"unknown",*|*,"unknown")
                echo "Using landscape display mode"
                echo "" >> ${MSO}
                echo "# SCREEN_${screens} stores the mode and device for screen ${screens}" >> ${MSO}
                echo "declare -A SCREEN_${screens}" >> ${MSO}
                echo "SCREEN_${screens}[mode]=" >> ${MSO}
                echo "SCREEN_${screens}[hdmi]=${HDMI}" >> ${MSO}
                break
                ;;
              *)
                printf "\nInvalid entry. Please try again"
                printf "\nEnter either a number or text of one of the menu entries\n"
                ;;
            esac
          done
          ((screens+=1))
        done
        echo "Setting ownership of MirrorCommandLine screen mode configuration file"
        [ "${USER}" ] || {
          USER=$(stat -c '%U' ${MMHOME}/config)
        }
        [ "${GROUP}" ] || {
          GROUP=`id -g -n ${USER}`
        }
        chown ${USER}:${GROUP} ${MSO}
        echo "MirrorCommandLine pre-installation configuration complete"
    ;;

    *)
    ;;
esac

exit 0
